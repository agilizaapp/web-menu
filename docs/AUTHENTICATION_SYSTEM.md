# Sistema de Autentica√ß√£o com Token do Cliente

## üîê Vis√£o Geral

Sistema de autentica√ß√£o persistente que salva o token do cliente em cookies por 1 ano, permitindo que usu√°rios retornem sem precisar preencher seus dados novamente.

## üìã Fluxo de Autentica√ß√£o

### 1. **Primeiro Acesso (Novo Cliente)**

```
1. Cliente clica em "Finalizar Pedido"
   ‚Üì
2. Modal de Telefone aparece
   ‚Üì
3. Cliente digita telefone ‚Üí API verifica se existe (/customer/{phone})
   ‚Üì
4. Se N√ÉO existe: Pede nome e data de nascimento
   ‚Üì
5. Cliente finaliza pedido ‚Üí API retorna TOKEN
   ‚Üì
6. Token salvo em cookie (1 ano) e localStorage
   ‚Üì
7. Pr√≥ximos acessos: cliente autenticado automaticamente
```

### 2. **Cliente Retornando (Com Token)**

```
1. Cliente clica em "Finalizar Pedido"
   ‚Üì
2. Sistema verifica token em cookie/localStorage
   ‚Üì
3. Faz requisi√ß√£o /config?config=true com token no header
   ‚Üì
4. API retorna dados do cliente
   ‚Üì
5. PULA modais de registro ‚Üí vai direto pro checkout
   ‚Üì
6. Cliente escolhe entrega/retirada e confirma
```

### 3. **Cliente Existente (Sem Token, mas cadastrado)**

```
1. Cliente clica em "Finalizar Pedido"
   ‚Üì
2. Modal de Telefone aparece
   ‚Üì
3. Cliente digita telefone ‚Üí API encontra cadastro
   ‚Üì
4. Nome √© PR√â-PREENCHIDO automaticamente
   ‚Üì
5. Cliente apenas confirma os dados
   ‚Üì
6. Finaliza pedido ‚Üí recebe novo token
```

## üîß Implementa√ß√£o

### Arquivos Criados/Modificados

#### 1. **src/services/cookies.ts** (NOVO)

Gerencia tokens em cookies:

```typescript
export const cookieService = {
  setCustomerToken(token: string): void
  getCustomerToken(): string | null
  removeCustomerToken(): void
  isAuthenticated(): boolean
}
```

**Caracter√≠sticas:**
- Expira em 1 ano
- `SameSite=Strict` (seguran√ßa)
- `Secure` (apenas HTTPS em produ√ß√£o)

#### 2. **src/stores/customerStore.ts** (NOVO)

Store Zustand com persist√™ncia em localStorage:

```typescript
interface CustomerState {
  token: string | null
  name: string | null
  phone: string | null
  address: AddressData | null
  isAuthenticated: boolean
  
  setCustomer: (data) => void
  updateAddress: (address) => void
  clearCustomer: () => void
}
```

#### 3. **src/services/api.ts** (ATUALIZADO)

Novos endpoints:

```typescript
// Buscar config com autentica√ß√£o
async getConfig(token: string): Promise<ConfigResponse>

// Buscar cliente por telefone
async getCustomerByPhone(phone: string): Promise<CustomerResponse | null>
```

**Estrutura de resposta:**

```typescript
interface ConfigResponse {
  store: Record<string, unknown>
  customer: {
    name: string
    phone: string // Formato: (67)*****9967
    address?: {
      street: string
      number: string
      neighborhood: string
      postalCode: string
    }
  }
}
```

#### 4. **src/components/customer/PaymentFlow.tsx** (ATUALIZADO)

Salva token ap√≥s criar pedido (PIX ou Cart√£o):

```typescript
// Ap√≥s criar pedido com sucesso
const apiToken = response.data.token

// ‚úÖ Salvar em cookie
cookieService.setCustomerToken(apiToken)

// ‚úÖ Salvar na store
setCustomer({
  token: apiToken,
  name: customerData.name,
  phone: customerData.phone,
  address: checkoutData.address
})
```

#### 5. **src/components/customer/RegisterModals.tsx** (ATUALIZADO)

Busca dados do cliente ao digitar telefone:

```typescript
const handleStep1Submit = async () => {
  // Validar telefone
  
  // ‚úÖ Buscar cliente na API
  const existingCustomer = await apiService.getCustomerByPhone(phone)
  
  if (existingCustomer) {
    // PR√â-PREENCHER nome
    setCustomerData({ ...prev, name: existingCustomer.name })
    toast.success(`Bem-vindo de volta, ${existingCustomer.name}!`)
  }
  
  setCurrentStep(2)
}
```

#### 6. **src/components/customer/CheckoutFlow.tsx** (ATUALIZADO)

Verifica autentica√ß√£o e pula modais:

```typescript
useEffect(() => {
  if (isAuthenticated && token) {
    // ‚úÖ Buscar dados atualizados
    const config = await apiService.getConfig(token)
    
    // ‚úÖ Atualizar store
    setCustomer(config.customer)
    
    // ‚úÖ PULAR registro ‚Üí ir direto pro checkout
    setCustomerData({...})
    setCurrentFlow("checkout")
    
    toast.success(`Bem-vindo de volta, ${config.customer.name}!`)
  }
}, [isAuthenticated, token])
```

## üì° Endpoints da API

### 1. **GET /config?config=true**

Busca configura√ß√µes e dados do cliente autenticado.

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Response:**
```json
{
  "store": {},
  "customer": {
    "name": "Jo√£o da Silva",
    "phone": "(67)*****9967",
    "address": {
      "street": "Rua das Flores",
      "number": "123",
      "neighborhood": "Centro",
      "postalCode": "12345678"
    }
  }
}
```

### 2. **GET /customer/{phone}**

Busca cliente por telefone (usado no modal de registro).

**Par√¢metro:**
- `phone`: Telefone sanitizado (ex: `5567984299967`)

**Response (200 - Cliente encontrado):**
```json
{
  "name": "Jo√£o da Silva",
  "phone": "(67)*****9967",
  "address": {
    "street": "Rua das Flores",
    "number": "123",
    "neighborhood": "Centro",
    "postalCode": "12345678"
  }
}
```

**Response (404 - Cliente n√£o encontrado):**
```json
null
```

### 3. **POST /order** (ATUALIZADO)

Ao criar pedido, retorna token.

**Response:**
```json
{
  "success": true,
  "data": {
    "orderId": 123,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "pix": {
      "copyAndPaste": "00020126..."
    }
  }
}
```

## üéØ Casos de Uso

### Caso 1: Novo Cliente

```
Input: Telefone n√£o cadastrado
Output: 
  - Modal de telefone
  - Modal de dados (nome + nascimento)
  - Cria pedido ‚Üí Recebe token
  - Token salvo ‚Üí Pr√≥ximas compras autenticadas
```

### Caso 2: Cliente Cadastrado (Sem Token)

```
Input: Telefone J√Å cadastrado, mas sem token local
Output:
  - Modal de telefone
  - API reconhece telefone
  - Modal de dados COM nome pr√©-preenchido
  - Cliente apenas confirma
  - Recebe novo token
```

### Caso 3: Cliente Autenticado (Com Token)

```
Input: Token v√°lido em cookie/localStorage
Output:
  - PULA modais completamente
  - Vai direto para escolha de entrega/retirada
  - Usa dados salvos
  - "Bem-vindo de volta, Jo√£o!"
```

## üîí Seguran√ßa

### Cookie

```javascript
{
  name: 'customer_token',
  expires: '1 year',
  sameSite: 'Strict',  // CSRF protection
  secure: true,        // HTTPS only (produ√ß√£o)
  path: '/'
}
```

### LocalStorage (via Zustand persist)

```javascript
{
  key: 'customer-storage',
  data: {
    token: string,
    name: string,
    phone: string,
    address: object
  }
}
```

### Valida√ß√£o de Token

- Token enviado no header `Authorization: Bearer {token}`
- API valida e retorna dados do cliente
- Se inv√°lido: cliente precisa fazer login novamente

## üß™ Como Testar

### 1. **Testar Novo Cliente**

```javascript
// Limpar dados primeiro
localStorage.clear()
document.cookie = 'customer_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC'

// Fazer pedido
// Verificar:
// - Modais de registro aparecem
// - Ap√≥s pedido, token √© salvo
// - Recarregar p√°gina ‚Üí dados permanecem
```

### 2. **Testar Cliente Retornando**

```javascript
// Ap√≥s ter feito um pedido:
// 1. Recarregar p√°gina
// 2. Clicar em "Finalizar Pedido"
// Verificar:
// - Modais N√ÉO aparecem
// - Vai direto pro checkout
// - Dados pr√©-preenchidos
```

### 3. **Testar Telefone Existente**

```javascript
// Simular API retornando cliente existente
// No modal de telefone:
// 1. Digite telefone cadastrado
// 2. Clicar "Continuar"
// Verificar:
// - Nome aparece pr√©-preenchido
// - Mensagem "Bem-vindo de volta!"
```

### 4. **Verificar Cookie**

```javascript
// Console do navegador:
console.log(document.cookie)
// Output: "customer_token=eyJhbGci..."

// Verificar expira√ß√£o (365 dias)
const cookies = document.cookie.split(';')
const tokenCookie = cookies.find(c => c.includes('customer_token'))
console.log(tokenCookie)
```

### 5. **Verificar Store**

```javascript
// Console do navegador:
const store = JSON.parse(localStorage.getItem('customer-storage'))
console.log(store)
// Output: { state: { token, name, phone, address, isAuthenticated } }
```

## üõ†Ô∏è Troubleshooting

### Problema: Token n√£o est√° sendo salvo

**Verificar:**
```javascript
// 1. Cookie foi criado?
console.log(document.cookie)

// 2. LocalStorage foi atualizado?
console.log(localStorage.getItem('customer-storage'))

// 3. API retornou token?
// DevTools ‚Üí Network ‚Üí POST /order ‚Üí Response
```

### Problema: Cliente autenticado mas modais aparecem

**Verificar:**
```javascript
// Store est√° com token?
import { useCustomerStore } from '@/stores'
const { token, isAuthenticated } = useCustomerStore()
console.log({ token, isAuthenticated })

// Se token existe mas isAuthenticated = false:
// ‚Üí Problema na store
```

### Problema: API retorna erro 401 no /config

**Causa:** Token inv√°lido ou expirado

**Solu√ß√£o:**
```javascript
// Limpar autentica√ß√£o
import { cookieService } from '@/services/cookies'
import { useCustomerStore } from '@/stores'

cookieService.removeCustomerToken()
useCustomerStore.getState().clearCustomer()

// Cliente far√° login novamente
```

### Problema: Telefone mascarado incorretamente na API

**Causa:** API retorna `(67)*****9967` mas c√≥digo espera formato completo

**Solu√ß√£o:**
- API deve retornar telefone mascarado apenas para exibi√ß√£o
- Para opera√ß√µes, usar telefone completo sanitizado
- Ou: desmascarar ao receber da API

## üìù Checklist de Integra√ß√£o

- [ ] API implementa `GET /config?config=true` com header Authorization
- [ ] API implementa `GET /customer/{phone}` (sanitizado: `5567984299967`)
- [ ] API retorna `token` no `POST /order`
- [ ] Token tem validade de 1 ano (ou mais)
- [ ] Telefone na resposta pode estar mascarado: `(67)*****9967`
- [ ] Address √© opcional (pode ser `null` ou ausente)
- [ ] Store vazio √© `{}` (objeto vazio, n√£o undefined)

## üé® UX/UI

### Loading States

```tsx
// Verificando autentica√ß√£o
{isLoadingAuth && (
  <div>Carregando...</div>
)}

// Buscando cliente por telefone
<Button disabled={isCheckingPhone}>
  {isCheckingPhone ? 'Verificando...' : 'Continuar'}
</Button>
```

### Toast Messages

```javascript
// Cliente novo
toast.info("Novo cliente! Por favor, preencha seus dados.")

// Cliente existente (sem token)
toast.success(`Bem-vindo de volta, ${name}!`)

// Cliente autenticado (com token)
toast.success(`Bem-vindo de volta, ${name}!`)
```

## üîÑ Fluxo Completo Visual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cliente clica em    ‚îÇ
‚îÇ "Finalizar Pedido"  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Tem token?   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   SIM          N√ÉO
     ‚îÇ            ‚îÇ
     ‚Üì            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ GET /config ‚îÇ  ‚îÇ Modal: Telefone  ‚îÇ
‚îÇ com token   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
       ‚îÇ                  ‚Üì
       ‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ          ‚îÇ GET /customer/{ph} ‚îÇ
       ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                    ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ            Existe      N√£o Existe
       ‚îÇ              ‚îÇ              ‚îÇ
       ‚îÇ              ‚Üì              ‚Üì
       ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ    ‚îÇ Nome pr√©-preench ‚îÇ  ‚îÇ Campos vazios ‚îÇ
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ             ‚îÇ                     ‚îÇ
       ‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                        ‚îÇ
       ‚îÇ                        ‚Üì
       ‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ            ‚îÇ Modal: Nome/Nascimento ‚îÇ
       ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                        ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚Üì
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Checkout Page    ‚îÇ
          ‚îÇ (Entrega/Retir.) ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚Üì
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Payment Flow     ‚îÇ
          ‚îÇ (PIX/Cart√£o)     ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚Üì
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ POST /order      ‚îÇ
          ‚îÇ ‚Üí Recebe TOKEN   ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚Üì
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Salvar token em: ‚îÇ
          ‚îÇ - Cookie (1 ano) ‚îÇ
          ‚îÇ - LocalStorage   ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**Vers√£o**: 1.0.0  
**Data**: Outubro 2025  
**Status**: ‚úÖ Implementado
